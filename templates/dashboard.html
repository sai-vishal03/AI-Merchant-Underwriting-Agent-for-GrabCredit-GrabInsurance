<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merchant Underwriting Dashboard</title>
  <style>
    :root {
      --ok: #15803d;
      --warn: #b45309;
      --risk: #c2410c;
      --bad: #b91c1c;
      --muted: #64748b;
      --line: #e2e8f0;
      --bg: #f8fafc;
      --card: #ffffff;
      --brand: #0f62fe;
      --brand-soft: #dbeafe;
      --text: #0f172a;
    }

    * { box-sizing: border-box; }
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: radial-gradient(circle at top right, #eff6ff, var(--bg) 40%);
      color: var(--text);
      padding: 22px;
    }

    .shell { max-width: 1400px; margin: 0 auto; }

    .hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 16px;
    }

    .title-wrap h1 { margin: 0; font-size: 28px; letter-spacing: -0.02em; }
    .subtitle { margin-top: 6px; color: var(--muted); font-size: 14px; }

    .mode-toggle {
      display: inline-flex;
      gap: 6px;
      padding: 6px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: var(--card);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }

    .mode-toggle a {
      text-decoration: none;
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 999px;
      color: #0f172a;
      border: 1px solid transparent;
    }

    .mode-toggle a.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(5, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04);
    }

    .label { font-size: 12px; color: var(--muted); }
    .value { font-size: 24px; font-weight: 700; margin-top: 6px; }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.05);
    }

    table { width: 100%; border-collapse: collapse; min-width: 1450px; }
    th, td { padding: 12px; border-bottom: 1px solid #eef2f7; text-align: left; vertical-align: top; }

    th {
      position: sticky;
      top: 0;
      background: #f8fbff;
      z-index: 1;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #475569;
    }

    .id-cell strong { font-size: 13px; }
    .muted { color: var(--muted); font-size: 12px; }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid;
    }
    .pill.approved { color: var(--ok); background: #ecfdf3; border-color: #bbf7d0; }
    .pill.rejected { color: var(--bad); background: #fef2f2; border-color: #fecaca; }
    .pill.mode { color: #1e40af; background: #eef2ff; border-color: #c7d2fe; }

    .tier-1 { color: var(--ok); font-weight: 700; }
    .tier-2 { color: var(--warn); font-weight: 700; }
    .tier-3 { color: var(--risk); font-weight: 700; }

    .confidence {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 120px;
    }
    .confidence-bar {
      height: 7px;
      border-radius: 999px;
      background: #e2e8f0;
      overflow: hidden;
    }
    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b, #22c55e);
    }

    .btn {
      padding: 7px 11px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
    }
    .btn[disabled] { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: var(--brand); border-color: var(--brand); color: #fff; }
    .btn-success { background: #15803d; border-color: #15803d; color: #fff; }

    .stack { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    details {
      background: #fcfdff;
      border: 1px solid #e7edf6;
      border-radius: 8px;
      padding: 8px 10px;
    }
    summary { cursor: pointer; font-weight: 600; }
    .detail-grid { margin-top: 10px; display: grid; gap: 10px; }
    .kv { font-size: 13px; }
    .ai-block {
      white-space: pre-wrap;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px;
      line-height: 1.4;
      font-size: 13px;
    }
    ul.inline-list { margin: 4px 0 0 18px; padding: 0; }

    .stat-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #dbeafe;
      background: var(--brand-soft);
      color: #1e3a8a;
      font-size: 12px;
      font-weight: 600;
    }

    @media (max-width: 920px) {
      .summary { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .hero { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="hero">
      <div class="title-wrap">
        <h1>Merchant Underwriting Dashboard</h1>
        <div class="subtitle">Explainable decisions, mode-aware offer operations, and decision-trail visibility.</div>
      </div>
      <div>
        <div class="mode-toggle">
          <a href="/ui?mode=grab_credit" class="{{ 'active' if mode == 'grab_credit' else '' }}">GrabCredit</a>
          <a href="/ui?mode=grab_insurance" class="{{ 'active' if mode == 'grab_insurance' else '' }}">GrabInsurance</a>
        </div>
      </div>
    </header>

    <section class="summary">
      <div class="card"><div class="label">Total Merchants</div><div class="value">{{ portfolio_summary.total_merchants }}</div></div>
      <div class="card"><div class="label">Approved</div><div class="value">{{ portfolio_summary.total_approved }}</div></div>
      <div class="card"><div class="label">Rejected</div><div class="value">{{ portfolio_summary.total_rejected }}</div></div>
      <div class="card"><div class="label">Rejection Rate %</div><div class="value">{{ portfolio_summary.rejection_rate_percentage }}</div></div>
      <div class="card"><div class="label">Credit Exposure (L)</div><div class="value">{{ portfolio_summary.total_credit_exposure_lakhs }}</div></div>
    </section>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Merchant</th>
            <th>Category</th>
            <th>Mode</th>
            <th>Status</th>
            <th>Tier</th>
            <th>Offer Details</th>
            <th>Confidence</th>
            <th>Offer Sent?</th>
            <th>Actions</th>
            <th>Decision Trail</th>
          </tr>
        </thead>
        <tbody>
          {% for m in merchants %}
          <tr id="row-{{ m.merchant_id }}">
            <td class="id-cell">
              <strong>{{ m.merchant_id }}</strong>
              <div class="muted">{{ m.phone_number or '-' }}</div>
            </td>
            <td>{{ m.category or '-' }}</td>
            <td>
              <span class="pill mode">{{ 'Credit' if m.mode == 'grab_credit' else 'Insurance' }}</span>
            </td>
            <td>
              {% if m.status == 'approved' %}
                <span class="pill approved">Approved</span>
              {% else %}
                <span class="pill rejected" title="{{ m.rejection_reason or 'Rejected by policy checks' }}">Rejected</span>
              {% endif %}
            </td>
            <td class="{{ m.tier_class }}">{{ m.tier or '-' }}</td>
            <td>
              {% if m.mode == 'grab_credit' and m.status == 'approved' %}
                <div>Credit Limit: ₹{{ m.credit_limit_lakhs }} L</div>
                <div>Rate: {{ m.interest_rate_pct }}%</div>
              {% elif m.mode == 'grab_insurance' and m.status == 'approved' %}
                <div>Coverage: ₹{{ m.coverage_amount_lakhs }} L</div>
                <div>Premium: {{ m.premium_quote_pct }}%</div>
                <div>Policy: {{ m.policy_type }}</div>
              {% else %}
                <span class="muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="confidence">
                <div>{{ m.confidence_level }}</div>
                <div class="confidence-bar"><div class="confidence-fill" style="width: {{ m.confidence_score }}%;"></div></div>
                <div class="muted">{{ m.confidence_score }}%</div>
              </div>
            </td>
            <td>
              <span id="sent-status-{{ m.merchant_id }}" class="stat-chip">{{ 'Yes' if m.offer_sent else 'No' }}</span>
            </td>
            <td>
              <div class="stack">
                {% if m.status == 'approved' and not m.offer_sent %}
                  <button
                    id="send-btn-{{ m.merchant_id }}"
                    class="btn btn-primary"
                    onclick="sendOffer('{{ m.merchant_id }}')"
                  >Send WhatsApp Offer</button>
                {% else %}
                  <span class="muted">{{ 'Sent' if m.offer_sent else 'N/A' }}</span>
                {% endif %}

                {% if m.status == 'approved' and m.offer_sent and not m.accepted %}
                  <button
                    id="accept-btn-{{ m.merchant_id }}"
                    class="btn btn-success"
                    onclick="acceptOffer('{{ m.merchant_id }}')"
                  >Accept Offer</button>
                {% elif m.accepted %}
                  <span class="muted">Mandate Initiated</span>
                {% else %}
                  <span class="muted">Awaiting send</span>
                {% endif %}
              </div>
            </td>
            <td>
              <details>
                <summary>View details</summary>
                <div class="detail-grid">
                  <div class="kv"><strong>AI Explanation</strong></div>
                  <div class="ai-block">{{ m.ai_explanation_full or 'No explanation available.' }}</div>

                  <div class="kv"><strong>Primary Risk Drivers</strong></div>
                  {% if m.primary_risk_drivers %}
                    <ul class="inline-list">
                      {% for item in m.primary_risk_drivers %}<li>{{ item }}</li>{% endfor %}
                    </ul>
                  {% else %}
                    <div class="muted">No primary risk drivers captured.</div>
                  {% endif %}

                  <div class="kv"><strong>Primary Strengths</strong></div>
                  {% if m.primary_strengths %}
                    <ul class="inline-list">
                      {% for item in m.primary_strengths %}<li>{{ item }}</li>{% endfor %}
                    </ul>
                  {% else %}
                    <div class="muted">No primary strengths captured.</div>
                  {% endif %}

                  <div class="kv"><strong>Key Metrics</strong></div>
                  <div class="muted">
                    YoY Growth: {{ m.decision_metrics.get('yoy_gmv_growth_pct', '-') }}% |
                    Refund: {{ m.decision_metrics.get('refund_rate_pct', '-') }}% |
                    Category Avg Refund: {{ m.decision_metrics.get('category_avg_refund_rate_pct', '-') }}% |
                    Customer Return: {{ m.decision_metrics.get('customer_return_rate_pct', '-') }}% |
                    Seasonality: {{ m.decision_metrics.get('seasonality_index', '-') }}
                  </div>
                </div>
              </details>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const DASHBOARD_MODE = {{ mode | tojson }};

    function setSentState(merchantId, sent) {
      const sentEl = document.getElementById(`sent-status-${merchantId}`);
      if (sentEl) sentEl.textContent = sent ? 'Yes' : 'No';
    }

    async function sendOffer(merchantId) {
      const btn = document.getElementById(`send-btn-${merchantId}`);
      if (!btn) return;

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const res = await fetch(`/send-offer/${merchantId}?mode=${DASHBOARD_MODE}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();

        if (!res.ok || data.status !== 'sent') {
          const msg = data?.detail || data?.delivery_info?.reason || 'Failed to send offer';
          throw new Error(msg);
        }

        setSentState(merchantId, true);
        btn.textContent = 'Sent';
        btn.classList.remove('btn-primary');
      } catch (error) {
        btn.disabled = false;
        btn.textContent = originalText;
        alert(`Failed to send WhatsApp offer: ${error.message}`);
      }
    }

    async function acceptOffer(merchantId) {
      const btn = document.getElementById(`accept-btn-${merchantId}`);
      if (!btn) return;

      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'Submitting...';

      try {
        const res = await fetch(`/accept-offer/${merchantId}?mode=${DASHBOARD_MODE}`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || 'Failed to accept offer');
        btn.textContent = 'Accepted';
      } catch (error) {
        btn.disabled = false;
        btn.textContent = originalText;
        alert(`Failed to accept offer: ${error.message}`);
      }
    }
  </script>
</body>
</html>
